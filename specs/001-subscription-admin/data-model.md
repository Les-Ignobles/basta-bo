# Data Model: Administration des Abonnements et Codes Promo

**Feature**: 001-subscription-admin
**Date**: 2026-01-30

## Entités

### 1. UserProfile (existante - lecture/écriture)

Table Supabase existante `user_profiles`.

```typescript
interface UserProfile {
  id: number
  uuid: string                      // FK vers auth.users
  email: string | null
  firstname: string | null
  avatar: string | null
  premium_sub_end_at: string | null // timestamptz - date fin abonnement
  is_admin: boolean
  role_scopes: RoleScope[]
  // ... autres champs non utilisés par cette feature
}

// DTO pour mise à jour abonnement
interface UpdateSubscriptionDto {
  premium_sub_end_at: string        // ISO 8601 timestamp
}
```

**Champs utilisés par cette feature** :
- `uuid` : identifiant unique, lien vers auth.users
- `email` : pour affichage
- `firstname` : pour affichage
- `premium_sub_end_at` : date de fin d'abonnement premium (modifiable)

---

### 2. AuthUser (Supabase - lecture seule)

Table Supabase `auth.users` accessible via Admin API.

```typescript
interface AuthUser {
  id: string                        // UUID
  email: string | null
  created_at: string
  // ... autres champs Supabase Auth
}
```

**Usage** : Recherche par email uniquement (email non stocké de manière fiable dans user_profiles).

---

### 3. PromoCode (existante - lecture/écriture)

Table Supabase existante `promo_codes`.

```typescript
interface PromoCode {
  id: number
  created_at: string                // timestamptz
  code: string                      // UNIQUE, 8 chars alphanumériques
  premium_end_at: string            // timestamptz - date fin premium à attribuer
  used_at: string | null            // timestamptz - null si non utilisé
}

// DTO création
interface CreatePromoCodeDto {
  code: string
  premium_end_at: string            // ISO 8601 timestamp
}

// Pas de UpdateDto - les codes ne sont pas modifiables
```

**Contraintes** :
- `code` : UNIQUE (géré par constraint SQL)
- `premium_end_at` : calculé à la création (now + 30j ou now + 365j)

---

### 4. SubscriptionAuditLog (nouvelle - écriture seule côté BO)

Nouvelle table pour l'historique des modifications.

```typescript
interface SubscriptionAuditLog {
  id: number
  created_at: string                // timestamptz
  admin_id: string                  // UUID admin
  admin_email: string               // email admin (dénormalisé pour lisibilité)
  user_id: string                   // UUID utilisateur modifié
  user_email: string                // email utilisateur (dénormalisé)
  previous_end_date: string | null  // timestamptz - ancienne date
  new_end_date: string              // timestamptz - nouvelle date
  action_type: ActionType           // type d'action
}

type ActionType = 'add_1_month' | 'add_1_year' | 'custom_date'

// DTO création
interface CreateSubscriptionAuditLogDto {
  admin_id: string
  admin_email: string
  user_id: string
  user_email: string
  previous_end_date: string | null
  new_end_date: string
  action_type: ActionType
}
```

---

## Relations

```
┌─────────────────┐         ┌─────────────────┐
│   auth.users    │         │  user_profiles  │
│─────────────────│         │─────────────────│
│ id (UUID) PK    │◄────────│ uuid (FK)       │
│ email           │         │ premium_sub_end │
│ created_at      │         │ firstname       │
└─────────────────┘         └─────────────────┘
                                    │
                                    │ user_id
                                    ▼
                            ┌─────────────────────────┐
                            │ subscription_audit_logs │
                            │─────────────────────────│
                            │ id PK                   │
                            │ admin_id                │
                            │ user_id                 │
                            │ previous_end_date       │
                            │ new_end_date            │
                            │ action_type             │
                            └─────────────────────────┘

┌─────────────────┐
│   promo_codes   │  (table indépendante)
│─────────────────│
│ id PK           │
│ code UNIQUE     │
│ premium_end_at  │
│ used_at         │
└─────────────────┘
```

---

## Migration SQL

```sql
-- Migration: 001_create_subscription_audit_logs.sql

CREATE TABLE IF NOT EXISTS subscription_audit_logs (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  admin_id UUID NOT NULL,
  admin_email TEXT NOT NULL,
  user_id UUID NOT NULL,
  user_email TEXT NOT NULL,
  previous_end_date TIMESTAMPTZ,
  new_end_date TIMESTAMPTZ NOT NULL,
  action_type TEXT NOT NULL CHECK (action_type IN ('add_1_month', 'add_1_year', 'custom_date'))
);

-- Index pour recherche par utilisateur
CREATE INDEX IF NOT EXISTS idx_subscription_audit_user_id
  ON subscription_audit_logs(user_id);

-- Index pour recherche par admin
CREATE INDEX IF NOT EXISTS idx_subscription_audit_admin_id
  ON subscription_audit_logs(admin_id);

-- Index pour tri chronologique
CREATE INDEX IF NOT EXISTS idx_subscription_audit_created_at
  ON subscription_audit_logs(created_at DESC);

COMMENT ON TABLE subscription_audit_logs IS 'Historique des modifications d''abonnement effectuées par les admins';
```

---

## Règles de validation

### UserProfile
- `premium_sub_end_at` : peut être null (jamais premium), dans le passé (expiré), ou dans le futur (actif)
- Lors de la modification : warning si date dans le passé, mais action autorisée

### PromoCode
- `code` : exactement 8 caractères, A-Z et 0-9 uniquement
- `premium_end_at` : doit être dans le futur à la création
- `used_at` : géré par l'app mobile lors de l'utilisation, non modifiable depuis le BO

### SubscriptionAuditLog
- `admin_id` : doit correspondre à un utilisateur avec scope `admin:write`
- `action_type` : enum strict, pas de valeurs arbitraires
- Insertion uniquement, pas de modification ni suppression
