# Quickstart: Administration des Abonnements et Codes Promo

**Feature**: 001-subscription-admin
**Date**: 2026-01-30

## Prérequis

- Node.js 22+
- Accès au projet basta-bo
- Variables d'environnement Supabase configurées :
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY`

## Installation

```bash
cd /Users/theochampion/Sites/les-ignobles/clients/basta/basta-bo
git checkout 001-subscription-admin
pnpm install
```

## Migration base de données

Exécuter dans la console Supabase SQL Editor :

```sql
-- Créer la table d'audit
CREATE TABLE IF NOT EXISTS subscription_audit_logs (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  admin_id UUID NOT NULL,
  admin_email TEXT NOT NULL,
  user_id UUID NOT NULL,
  user_email TEXT NOT NULL,
  previous_end_date TIMESTAMPTZ,
  new_end_date TIMESTAMPTZ NOT NULL,
  action_type TEXT NOT NULL CHECK (action_type IN ('add_1_month', 'add_1_year', 'custom_date'))
);

CREATE INDEX IF NOT EXISTS idx_subscription_audit_user_id ON subscription_audit_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_subscription_audit_admin_id ON subscription_audit_logs(admin_id);
CREATE INDEX IF NOT EXISTS idx_subscription_audit_created_at ON subscription_audit_logs(created_at DESC);
```

## Lancer le projet

```bash
pnpm dev
```

Accéder à :
- http://localhost:3000/dashboard/subscriptions
- http://localhost:3000/dashboard/promo-codes

## Structure des fichiers à créer

```
app/
├── api/
│   ├── subscriptions/
│   │   ├── route.ts
│   │   ├── profile/route.ts
│   │   └── audit/route.ts
│   └── promo-codes/
│       └── route.ts
└── dashboard/
    ├── subscriptions/
    │   └── page.tsx
    └── promo-codes/
        └── page.tsx

features/
└── subscriptions/
    ├── repositories/
    │   ├── user-profile-repository.ts
    │   ├── promo-code-repository.ts
    │   └── subscription-audit-repository.ts
    ├── stores/
    │   ├── subscription-store.ts
    │   └── promo-code-store.ts
    ├── types/
    │   └── index.ts
    └── components/
        ├── user-search-form.tsx
        ├── user-profile-card.tsx
        ├── subscription-actions.tsx
        ├── promo-code-form.tsx
        └── promo-codes-table.tsx
```

## Ordre d'implémentation recommandé

### Phase 1 : Infrastructure
1. Types TypeScript (`features/subscriptions/types/index.ts`)
2. Repositories (`features/subscriptions/repositories/`)
3. Migration SQL (table `subscription_audit_logs`)

### Phase 2 : Page Abonnements
4. API routes subscriptions (`app/api/subscriptions/`)
5. Store subscriptions (`features/subscriptions/stores/subscription-store.ts`)
6. Composants abonnements (`features/subscriptions/components/user-*.tsx`)
7. Page abonnements (`app/dashboard/subscriptions/page.tsx`)

### Phase 3 : Page Codes Promo
8. API routes promo-codes (`app/api/promo-codes/route.ts`)
9. Store promo-codes (`features/subscriptions/stores/promo-code-store.ts`)
10. Composants codes promo (`features/subscriptions/components/promo-*.tsx`)
11. Page codes promo (`app/dashboard/promo-codes/page.tsx`)

### Phase 4 : Intégration
12. Sidebar (`components/app-sidebar.tsx` - ajouter les liens)
13. Middleware permissions (si nécessaire)

## Test manuel

### Page Abonnements
1. Se connecter en tant qu'admin
2. Aller sur `/dashboard/subscriptions`
3. Rechercher un utilisateur par email
4. Vérifier l'affichage du profil
5. Cliquer sur "Ajouter 1 mois"
6. Vérifier la mise à jour de la date

### Page Codes Promo
1. Aller sur `/dashboard/promo-codes`
2. Cliquer sur "Générer un code" (1 mois)
3. Vérifier que le code apparaît dans la liste
4. Copier le code (bouton copier)
5. Filtrer par "Non utilisés"

## Références

- [Spec](./spec.md) - Spécification fonctionnelle
- [Plan](./plan.md) - Plan d'implémentation
- [Data Model](./data-model.md) - Modèle de données
- [API Subscriptions](./contracts/api-subscriptions.md) - Contract API abonnements
- [API Promo Codes](./contracts/api-promo-codes.md) - Contract API codes promo
